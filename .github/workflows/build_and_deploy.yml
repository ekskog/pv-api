name: Build and Deploy PhotoVault API

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/ekskog/photovault-api

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set Environment Variables
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          # Use run number to ensure K8s sees a unique version string
          echo "IMAGE_TAG=${{ env.IMAGE_NAME }}:${{ github.run_number }}-$SHORT_SHA" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

      - name: Check if app source code changed
        id: check_changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -vE '^(\.github/|k8s/|README\.md|\.gitignore)' | grep -q .; then
            echo "APP_CHANGED=true" >> $GITHUB_ENV
          else
            echo "APP_CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Set up Docker Buildx
        if: env.APP_CHANGED == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: env.APP_CHANGED == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.EK_GITHUB_PAT }}

      - name: Build and Push Docker Image
        if: env.APP_CHANGED == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          # THE CRITICAL FIX: Kill the cache to fix the corrupted package.json
          no-cache: true 
          tags: |
            ${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
      
      - name: Set Up KUBECONFIG
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
          echo "KUBECONFIG=$PWD/kubeconfig.yaml" >> $GITHUB_ENV
          kubectl cluster-info --kubeconfig=kubeconfig.yaml
                    
      - name: Create or Update Image Pull Secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password="${{ secrets.EK_GITHUB_PAT }}" \
            --namespace=photovault \
            --kubeconfig=kubeconfig.yaml \
            --dry-run=client -o yaml | kubectl apply -f - --kubeconfig=kubeconfig.yaml

      - name: Update API Deployment
        run: |
          echo "ðŸš€ Updating API to image: ${{ env.IMAGE_TAG }}"
          
          kubectl set image deployment/photovault-api \
            photovault-api=${{ env.IMAGE_TAG }} \
            --namespace=photovault --kubeconfig=kubeconfig.yaml
          
          kubectl apply -f k8s/configmap.yaml --kubeconfig=kubeconfig.yaml --namespace=photovault
          kubectl apply -f k8s/secrets.yaml --kubeconfig=kubeconfig.yaml --namespace=photovault

      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/photovault-api \
            --namespace=photovault --kubeconfig=kubeconfig.yaml --timeout=300s

      - name: Cleanup
        if: always()
        run: rm -f kubeconfig.yaml